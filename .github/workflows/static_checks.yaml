name: Static checks
run-name: Static checks
on:
    pull_request:
      types: [opened,synchronize,labeled]
env:
 BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
permissions:
  contents: write
jobs:
  pre-commit-run:
    name: Pre-commit run
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{env.BRANCH_NAME}}
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install \
           pre-commit
        pip install identify --upgrade
        pre-commit install
    - name: Run pre-commit on all files
      id: pre-commit
      run: pre-commit run --all --color always --verbose
    - name: Commit pre-commit fixes
      if: ${{contains(github.event.pull_request.labels.*.name, 'auto-fix') && failure() && steps.pre-commit.conclusion == 'failure'}}
      run: |
         git config user.name github-actions
         git config user.email github-actions@github.com
         git add .
         git commit -m 'fix format'
         git push origin ${{env.BRANCH_NAME}}
    - name: check for todo fixme note
      run: |
        NTODOS="$(grep -r 'TODO DONT MERGE' --exclude-dir=.github | wc -l)"
        echo "Found $NTODOS TODO DONT MERGE notes"
        ! grep -q -r "TODO DONT MERGE" --exclude-dir=.github
  build-compilation-db:
    if: ${{!contains(github.event.pull_request.labels.*.name, 'Skip-build') }}
    name: Build with IWYU
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Add clang repo
      run: |
        sudo add-apt-repository 'deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-16 main'
        wget https://apt.llvm.org/llvm-snapshot.gpg.key
        sudo apt-key add llvm-snapshot.gpg.key

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install \
           ninja-build \
           iwyu \
           clang-16 \
           libomp-16-dev \
           libopenmpi-dev \
           openmpi-bin

    - name: Set up cache
      uses: actions/cache@v4
      with:
        if: ${{!contains(github.event.pull_request.labels.*.name, 'Skip-cache')}}
        path: build
        key: static_PR_${{ github.event.pull_request.number }}

    - name: Create Compilation Database
      run: |
        cmake --preset develop \
          -DNEOFOAM_DEVEL_TOOLS=OFF \
          -DCMAKE_CXX_COMPILER=clang++-16 \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DNEOFOAM_ENABLE_MPI_WITH_THREAD_SUPPORT=OFF \
          -DNEOFOAM_ENABLE_IWYU=ON
        cmake --build --preset develop
    - uses: actions/upload-artifact@v4
      with:
        name: build-artifact
        path: build
  clang-tidy-check:
    name: Clang-tidy Check
    runs-on: ubuntu-latest
    needs: [build-compilation-db]
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{env.BRANCH_NAME}}

    - name: Add clang repo
      run: |
        sudo add-apt-repository 'deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-16 main'
        wget https://apt.llvm.org/llvm-snapshot.gpg.key
        sudo apt-key add llvm-snapshot.gpg.key

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install \
           clang-tidy-16 \
           libomp-16-dev \
           libopenmpi-dev \
           openmpi-bin

    - uses: actions/download-artifact@v4
      with:
        name: build-artifact
        path: build

    - name: Run clang-tidy
      run: |
        # Create list of .cpp files belonging to this repository
        git ls-files | grep -E "\.(cpp)" > pattern
        # Create list of .cpp files that are in this repository and part of the
        # compilation database
        # also filters out " at the begin and end of the filename
        jq ".[] | .file" build/develop/compile_commands.json \
          | sed 's/^"\(.*\)"$/\1/' \
          | grep -F -f pattern - > files
        # run clang-tidy on all specified files
        clang-tidy-16 --fix --extra-arg=-w -p build/develop $(cat files)
    - name: Check for fixes
      id: tidy-fixes
      run: |
        if [[ $(git ls-files -m | wc -l) -eq 0 ]]; then
          exit 0
        fi
        echo "There are fixes available from clang-tidy."
        echo "Please use your local clang-tidy or apply the following patch:"
        git diff -p
        exit 1
    - name: Commit clang-tidy-fixes
      if: ${{contains(github.event.pull_request.labels.*.name, 'auto-fix') && failure() && steps.tidy-fixes.conclusion == 'failure'}}
      run: |
         rm pattern files
         git config user.name github-actions
         git config user.email github-actions@github.com
         git add .
         git commit -m 'fix format'
         git push origin ${{ github.BRANCH_NAME }}
  changelog:
    if: ${{!contains(github.event.pull_request.labels.*.name, 'Skip-Changelog')}}
    name: Changelog check
    runs-on: ubuntu-latest
    steps:
    - uses: dangoslen/changelog-enforcer@v3
      with:
        changeLogPath: CHANGELOG.md
  fixmes:
    name: FIXME check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: greole/action-fixme-check@master # or @ the latest release
      with:
        terms: 'FIXME' # optional, defaults to `FIXME`
        case-sensitive: false  # optional, defaults to `true`
